#!/bin/bash

PORT=23456
SERVER=./nimd

echo "Starting nimd server..."

if [ ! -f "$SERVER" ]; then
    echo "❌ ERROR: nimd binary not found. Run 'make' first."
    exit 1
fi

$SERVER $PORT &
SERVER_PID=$!

sleep 2

kill_server() {
    kill $SERVER_PID 2>/dev/null
}

pass() {
    echo "✅ PASS: $1"
}

fail() {
    echo "❌ FAIL: $1"
}

# ---------------------------
# 1. Malformed framing
# ---------------------------
echo "Test 1: Malformed frame"
echo "OPEN|Alice|" | nc localhost $PORT -w 1 > /tmp/out1.txt
grep -q "FAIL" /tmp/out1.txt && pass "Malformed frame detected" || fail "Malformed frame not detected"

# ---------------------------
# 2. Cannot parse message
# ---------------------------
echo "Test 2: Unparsable message"
printf "0|04|MOVE|" | nc localhost $PORT -w 1 > /tmp/out2.txt
grep -q "FAIL" /tmp/out2.txt && pass "Parsing failure handled" || fail "Malformed accepted"

# ---------------------------
# 3. MOVE before OPEN
# ---------------------------
echo "Test 3: MOVE before OPEN"
printf "0|09|MOVE|1|1|" | nc localhost $PORT -w 1 > /tmp/out3.txt
grep -q "FAIL" /tmp/out3.txt && pass "MOVE rejected before OPEN" || fail "MOVE accepted before OPEN"

# ---------------------------
# 4. OPEN -> WAIT
# ---------------------------
echo "Test 4: OPEN causes WAIT"
{
    printf "0|11|OPEN|Alice|\n"
    sleep 1
} | nc localhost $PORT > /tmp/out4.txt

grep -q "WAIT" /tmp/out4.txt && pass "WAIT received" || fail "WAIT not sent"

# ---------------------------
# 5. Match creation
# ---------------------------
echo "Test 5: Match creation"
{
    printf "0|11|OPEN|Bob|\n"
    sleep 1
} | nc localhost $PORT > /tmp/out5.txt

grep -q "NAME" /tmp/out4.txt && pass "NAME received (match created)" || fail "No match response"

# ---------------------------
# Cleanup
# ---------------------------
kill_server
echo "Tests completed."
